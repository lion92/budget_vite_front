# Makefile pour l'application Budget
# Facilite les commandes Docker et la gestion de l'environnement

# Variables
COMPOSE_FILE_DEV = docker-compose.full.yml
COMPOSE_FILE_PROD = docker-compose.full.yml
PROJECT_NAME = budget-app

# Couleurs pour l'affichage
BLUE = \033[0;34m
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

.PHONY: help

# =====================================================================
# AIDE
# =====================================================================
help: ## Affiche cette aide
	@echo "${BLUE}ğŸ  Budget Management Application${NC}"
	@echo "${BLUE}=================================${NC}"
	@echo ""
	@echo "Commandes disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "${GREEN}%-20s${NC} %s\n", $$1, $$2}'

# =====================================================================
# ENVIRONNEMENT
# =====================================================================
setup: ## Configuration initiale du projet
	@echo "${BLUE}ğŸ“¦ Configuration initiale...${NC}"
	@cp .env.example .env
	@echo "${GREEN}âœ… Fichier .env crÃ©Ã©${NC}"
	@echo "${YELLOW}âš ï¸  Veuillez modifier le fichier .env avec vos paramÃ¨tres${NC}"

env-check: ## VÃ©rifier la configuration des variables d'environnement
	@echo "${BLUE}ğŸ” VÃ©rification de l'environnement...${NC}"
	@if [ ! -f .env ]; then echo "${RED}âŒ Fichier .env manquant. Lancez 'make setup'${NC}"; exit 1; fi
	@echo "${GREEN}âœ… Fichier .env trouvÃ©${NC}"

# =====================================================================
# DÃ‰VELOPPEMENT
# =====================================================================
dev: env-check ## DÃ©marrer l'environnement de dÃ©veloppement
	@echo "${BLUE}ğŸš€ DÃ©marrage de l'environnement de dÃ©veloppement...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) --profile development up -d
	@echo "${GREEN}âœ… Environnement de dÃ©veloppement dÃ©marrÃ©${NC}"
	@echo "${YELLOW}Frontend: http://localhost:3000${NC}"
	@echo "${YELLOW}Backend API: http://localhost:3010${NC}"
	@echo "${YELLOW}Base de donnÃ©es: localhost:5432${NC}"

dev-build: ## Construire les images pour le dÃ©veloppement
	@echo "${BLUE}ğŸ”¨ Construction des images de dÃ©veloppement...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) --profile development build --no-cache

dev-logs: ## Afficher les logs de dÃ©veloppement
	docker-compose -f $(COMPOSE_FILE_DEV) --profile development logs -f

dev-down: ## ArrÃªter l'environnement de dÃ©veloppement
	@echo "${BLUE}â¹ï¸  ArrÃªt de l'environnement de dÃ©veloppement...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) --profile development down

# =====================================================================
# PRODUCTION
# =====================================================================
prod: env-check ## DÃ©marrer l'environnement de production
	@echo "${BLUE}ğŸš€ DÃ©marrage de l'environnement de production...${NC}"
	docker-compose -f $(COMPOSE_FILE_PROD) --profile production up -d
	@echo "${GREEN}âœ… Environnement de production dÃ©marrÃ©${NC}"
	@echo "${YELLOW}Application: http://localhost${NC}"

prod-build: ## Construire les images pour la production
	@echo "${BLUE}ğŸ”¨ Construction des images de production...${NC}"
	docker-compose -f $(COMPOSE_FILE_PROD) --profile production build --no-cache

prod-logs: ## Afficher les logs de production
	docker-compose -f $(COMPOSE_FILE_PROD) --profile production logs -f

prod-down: ## ArrÃªter l'environnement de production
	@echo "${BLUE}â¹ï¸  ArrÃªt de l'environnement de production...${NC}"
	docker-compose -f $(COMPOSE_FILE_PROD) --profile production down

# =====================================================================
# BASE DE DONNÃ‰ES
# =====================================================================
db-start: ## DÃ©marrer uniquement la base de donnÃ©es
	@echo "${BLUE}ğŸ—„ï¸  DÃ©marrage de la base de donnÃ©es...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) up -d database redis

db-stop: ## ArrÃªter la base de donnÃ©es
	@echo "${BLUE}â¹ï¸  ArrÃªt de la base de donnÃ©es...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) stop database redis

db-backup: ## CrÃ©er une sauvegarde de la base de donnÃ©es
	@echo "${BLUE}ğŸ’¾ CrÃ©ation d'une sauvegarde...${NC}"
	@mkdir -p ./database/backups
	docker-compose -f $(COMPOSE_FILE_DEV) exec database pg_dump -U budget_app_user budget_app > ./database/backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "${GREEN}âœ… Sauvegarde crÃ©Ã©e dans ./database/backups/${NC}"

db-restore: ## Restaurer la base de donnÃ©es (usage: make db-restore FILE=backup.sql)
	@if [ -z "$(FILE)" ]; then echo "${RED}âŒ SpÃ©cifiez le fichier: make db-restore FILE=backup.sql${NC}"; exit 1; fi
	@echo "${BLUE}ğŸ“¥ Restauration de la base de donnÃ©es...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) exec -T database psql -U budget_app_user budget_app < ./database/backups/$(FILE)
	@echo "${GREEN}âœ… Base de donnÃ©es restaurÃ©e${NC}"

db-reset: ## RÃ©initialiser complÃ¨tement la base de donnÃ©es
	@echo "${RED}âš ï¸  ATTENTION: Cette action va supprimer toutes les donnÃ©es!${NC}"
	@echo -n "Continuer? [y/N] " && read ans && [ $${ans:-N} = y ]
	docker-compose -f $(COMPOSE_FILE_DEV) down -v
	docker volume rm budget-app_postgres_data || true
	@echo "${GREEN}âœ… Base de donnÃ©es rÃ©initialisÃ©e${NC}"

# =====================================================================
# OUTILS
# =====================================================================
tools: ## DÃ©marrer les outils de dÃ©veloppement (Adminer, etc.)
	@echo "${BLUE}ğŸ› ï¸  DÃ©marrage des outils...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) --profile tools up -d
	@echo "${GREEN}âœ… Outils dÃ©marrÃ©s${NC}"
	@echo "${YELLOW}Adminer (DB): http://localhost:8080${NC}"

monitoring: ## DÃ©marrer les outils de monitoring
	@echo "${BLUE}ğŸ“Š DÃ©marrage du monitoring...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) --profile monitoring up -d
	@echo "${GREEN}âœ… Monitoring dÃ©marrÃ©${NC}"
	@echo "${YELLOW}Grafana: http://localhost:3001${NC}"
	@echo "${YELLOW}Prometheus: http://localhost:9090${NC}"

# =====================================================================
# MAINTENANCE
# =====================================================================
clean: ## Nettoyer les containers et images inutilisÃ©s
	@echo "${BLUE}ğŸ§¹ Nettoyage...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) down --remove-orphans
	docker system prune -f
	docker volume prune -f
	@echo "${GREEN}âœ… Nettoyage terminÃ©${NC}"

clean-all: ## Nettoyage complet (ATTENTION: supprime tout)
	@echo "${RED}âš ï¸  ATTENTION: Cette action va supprimer tous les containers, images et volumes!${NC}"
	@echo -n "Continuer? [y/N] " && read ans && [ $${ans:-N} = y ]
	docker-compose -f $(COMPOSE_FILE_DEV) down -v --remove-orphans
	docker system prune -a -f --volumes
	@echo "${GREEN}âœ… Nettoyage complet terminÃ©${NC}"

restart: ## RedÃ©marrer tous les services
	@echo "${BLUE}ğŸ”„ RedÃ©marrage des services...${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) restart
	@echo "${GREEN}âœ… Services redÃ©marrÃ©s${NC}"

# =====================================================================
# LOGS ET DEBUG
# =====================================================================
logs: ## Afficher tous les logs
	docker-compose -f $(COMPOSE_FILE_DEV) logs -f

logs-backend: ## Afficher les logs du backend
	docker-compose -f $(COMPOSE_FILE_DEV) logs -f backend

logs-frontend: ## Afficher les logs du frontend
	docker-compose -f $(COMPOSE_FILE_DEV) logs -f frontend-dev

logs-db: ## Afficher les logs de la base de donnÃ©es
	docker-compose -f $(COMPOSE_FILE_DEV) logs -f database

status: ## Afficher le statut des services
	@echo "${BLUE}ğŸ“Š Statut des services:${NC}"
	docker-compose -f $(COMPOSE_FILE_DEV) ps

health: ## VÃ©rifier la santÃ© des services
	@echo "${BLUE}ğŸ¥ VÃ©rification de la santÃ© des services:${NC}"
	@docker-compose -f $(COMPOSE_FILE_DEV) ps --filter "health=healthy" --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"

# =====================================================================
# DÃ‰VELOPPEMENT FRONTEND
# =====================================================================
frontend-install: ## Installer les dÃ©pendances frontend
	@echo "${BLUE}ğŸ“¦ Installation des dÃ©pendances frontend...${NC}"
	npm install --legacy-peer-deps

frontend-build: ## Construire le frontend pour la production
	@echo "${BLUE}ğŸ”¨ Construction du frontend...${NC}"
	npm run build

frontend-test: ## Lancer les tests frontend
	@echo "${BLUE}ğŸ§ª Tests frontend...${NC}"
	npm run test

# =====================================================================
# DÃ‰PLOIEMENT
# =====================================================================
deploy-staging: ## DÃ©ployer en staging
	@echo "${BLUE}ğŸš€ DÃ©ploiement en staging...${NC}"
	# Commandes de dÃ©ploiement Ã  personnaliser

deploy-prod: ## DÃ©ployer en production
	@echo "${BLUE}ğŸš€ DÃ©ploiement en production...${NC}"
	# Commandes de dÃ©ploiement Ã  personnaliser

# =====================================================================
# SÃ‰CURITÃ‰
# =====================================================================
security-scan: ## Scanner les vulnÃ©rabilitÃ©s
	@echo "${BLUE}ğŸ”’ Scan de sÃ©curitÃ©...${NC}"
	docker run --rm -v $(PWD):/app clair-scanner:latest
	npm audit

update-deps: ## Mettre Ã  jour les dÃ©pendances
	@echo "${BLUE}ğŸ“¦ Mise Ã  jour des dÃ©pendances...${NC}"
	npm update
	docker-compose -f $(COMPOSE_FILE_DEV) pull

# Commande par dÃ©faut
.DEFAULT_GOAL := help